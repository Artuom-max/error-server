from http.server import HTTPServer, BaseHTTPRequestHandler
import json
import urllib.parse
import sqlite3
import hashlib
import time
from datetime import datetime, timedelta
import threading
import socket
import os

# === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ê–î–ú–ò–ù–ê ===
ADMIN_LOGIN = "Artuom_SS-Owner"
ADMIN_PASSWORD_HASH = hashlib.sha256("1286".encode()).hexdigest()

class AdminSystem:
    """–°–∏—Å—Ç–µ–º–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è"""
    
    def __init__(self):
        self.conn = sqlite3.connect('admin.db', check_same_thread=False)
        self.create_tables()
        self.sessions = {}
        self.banned_ips = {}
        self.muted_clients = {}
        self.punishment_history = []
        
    def create_tables(self):
        """–°–æ–∑–¥–∞—ë—Ç —Ç–∞–±–ª–∏—Ü—ã –≤ –ë–î"""
        cursor = self.conn.cursor()
        
        # –ö–ª–∏–µ–Ω—Ç—ã
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS clients (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                ip TEXT UNIQUE,
                name TEXT,
                token TEXT,
                registered DATETIME DEFAULT CURRENT_TIMESTAMP,
                last_seen DATETIME,
                messages_sent INTEGER DEFAULT 0,
                is_banned BOOLEAN DEFAULT 0,
                ban_reason TEXT,
                ban_until DATETIME,
                is_muted BOOLEAN DEFAULT 0,
                mute_until DATETIME
            )
        ''')
        
        # –ò—Å—Ç–æ—Ä–∏—è –Ω–∞–∫–∞–∑–∞–Ω–∏–π
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS punishments (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                client_ip TEXT,
                admin TEXT,
                action TEXT,
                reason TEXT,
                duration TEXT,
                created DATETIME DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # VBS —Å–∫—Ä–∏–ø—Ç—ã
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS vbs_scripts (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT,
                code TEXT,
                created_by TEXT,
                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                uses INTEGER DEFAULT 0
            )
        ''')
        
        self.conn.commit()
    
    def authenticate_admin(self, login, password):
        """–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∞–¥–º–∏–Ω–∞"""
        if login != ADMIN_LOGIN:
            return False
        
        password_hash = hashlib.sha256(password.encode()).hexdigest()
        return password_hash == ADMIN_PASSWORD_HASH
    
    def create_session(self, login):
        """–°–æ–∑–¥–∞—ë—Ç —Å–µ—Å—Å–∏—é –∞–¥–º–∏–Ω–∞"""
        session_id = hashlib.sha256(f"{login}{time.time()}".encode()).hexdigest()
        self.sessions[session_id] = {
            'login': login,
            'created': datetime.now(),
            'last_activity': datetime.now()
        }
        return session_id
    
    def validate_session(self, session_id):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Å–µ—Å—Å–∏–∏"""
        if session_id in self.sessions:
            session = self.sessions[session_id]
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (30 –º–∏–Ω—É—Ç)
            if (datetime.now() - session['last_activity']).seconds < 1800:
                session['last_activity'] = datetime.now()
                return True
            else:
                del self.sessions[session_id]
        return False
    
    def register_client(self, ip, name, token=None):
        """–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞"""
        if not token:
            token = hashlib.sha256(f"{ip}{name}{time.time()}".encode()).hexdigest()[:16]
        
        cursor = self.conn.cursor()
        
        try:
            cursor.execute('''
                INSERT OR REPLACE INTO clients 
                (ip, name, token, last_seen, messages_sent)
                VALUES (?, ?, ?, ?, ?)
            ''', (ip, name, token, datetime.now(), 0))
            
            self.conn.commit()
            return token
        except:
            return None
    
    def get_client(self, ip):
        """–ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∏–µ–Ω—Ç–µ"""
        cursor = self.conn.cursor()
        cursor.execute('SELECT * FROM clients WHERE ip = ?', (ip,))
        row = cursor.fetchone()
        
        if row:
            columns = [desc[0] for desc in cursor.description]
            return dict(zip(columns, row))
        return None
    
    def update_client_activity(self, ip):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç –≤—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞"""
        cursor = self.conn.cursor()
        cursor.execute('''
            UPDATE clients 
            SET last_seen = ? 
            WHERE ip = ?
        ''', (datetime.now(), ip))
        self.conn.commit()
    
    def ban_client(self, client_ip, admin, reason, duration_minutes):
        """–ë–∞–Ω–∏—Ç –∫–ª–∏–µ–Ω—Ç–∞"""
        cursor = self.conn.cursor()
        ban_until = datetime.now() + timedelta(minutes=duration_minutes)
        
        cursor.execute('''
            UPDATE clients 
            SET is_banned = 1, 
                ban_reason = ?,
                ban_until = ?
            WHERE ip = ?
        ''', (reason, ban_until, client_ip))
        
        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
        cursor.execute('''
            INSERT INTO punishments 
            (client_ip, admin, action, reason, duration)
            VALUES (?, ?, ?, ?, ?)
        ''', (client_ip, admin, 'ban', reason, f"{duration_minutes} –º–∏–Ω"))
        
        self.conn.commit()
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤ –ø–∞–º—è—Ç—å –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
        self.banned_ips[client_ip] = ban_until
        
        return True
    
    def mute_client(self, client_ip, admin, reason, duration_minutes):
        """–ú—É—Ç–∏—Ç –∫–ª–∏–µ–Ω—Ç–∞ (–∑–∞–ø—Ä–µ—â–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è)"""
        cursor = self.conn.cursor()
        mute_until = datetime.now() + timedelta(minutes=duration_minutes)
        
        cursor.execute('''
            UPDATE clients 
            SET is_muted = 1,
                mute_until = ?
            WHERE ip = ?
        ''', (mute_until, client_ip))
        
        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
        cursor.execute('''
            INSERT INTO punishments 
            (client_ip, admin, action, reason, duration)
            VALUES (?, ?, ?, ?, ?)
        ''', (client_ip, admin, 'mute', reason, f"{duration_minutes} –º–∏–Ω"))
        
        self.conn.commit()
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤ –ø–∞–º—è—Ç—å
        self.muted_clients[client_ip] = mute_until
        
        return True
    
    def unban_client(self, client_ip, admin):
        """–†–∞–∑–±–∞–Ω–∏–≤–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞"""
        cursor = self.conn.cursor()
        cursor.execute('''
            UPDATE clients 
            SET is_banned = 0,
                ban_reason = NULL,
                ban_until = NULL
            WHERE ip = ?
        ''', (client_ip,))
        
        if client_ip in self.banned_ips:
            del self.banned_ips[client_ip]
        
        cursor.execute('''
            INSERT INTO punishments 
            (client_ip, admin, action, reason, duration)
            VALUES (?, ?, ?, ?, ?)
        ''', (client_ip, admin, 'unban', '–†—É—á–Ω–∞—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞', '0'))
        
        self.conn.commit()
        return True
    
    def unmute_client(self, client_ip, admin):
        """–†–∞–∑–º—É—á–∏–≤–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞"""
        cursor = self.conn.cursor()
        cursor.execute('''
            UPDATE clients 
            SET is_muted = 0,
                mute_until = NULL
            WHERE ip = ?
        ''', (client_ip,))
        
        if client_ip in self.muted_clients:
            del self.muted_clients[client_ip]
        
        cursor.execute('''
            INSERT INTO punishments 
            (client_ip, admin, action, reason, duration)
            VALUES (?, ?, ?, ?, ?)
        ''', (client_ip, admin, 'unmute', '–†—É—á–Ω–æ–µ —Å–Ω—è—Ç–∏–µ –º—É—Ç–∞', '0'))
        
        self.conn.commit()
        return True
    
    def save_vbs_script(self, name, code, created_by):
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç VBS —Å–∫—Ä–∏–ø—Ç"""
        cursor = self.conn.cursor()
        
        cursor.execute('''
            INSERT INTO vbs_scripts (name, code, created_by, uses)
            VALUES (?, ?, ?, ?)
        ''', (name, code, created_by, 0))
        
        self.conn.commit()
        return cursor.lastrowid
    
    def get_vbs_scripts(self):
        """–ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ VBS —Å–∫—Ä–∏–ø—Ç–æ–≤"""
        cursor = self.conn.cursor()
        cursor.execute('SELECT * FROM vbs_scripts ORDER BY id DESC')
        
        scripts = []
        for row in cursor.fetchall():
            columns = [desc[0] for desc in cursor.description]
            scripts.append(dict(zip(columns, row)))
        
        return scripts
    
    def increment_script_uses(self, script_id):
        """–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞"""
        cursor = self.conn.cursor()
        cursor.execute('''
            UPDATE vbs_scripts 
            SET uses = uses + 1 
            WHERE id = ?
        ''', (script_id,))
        self.conn.commit()
    
    def get_all_clients(self):
        """–ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤"""
        cursor = self.conn.cursor()
        cursor.execute('SELECT * FROM clients ORDER BY last_seen DESC')
        
        clients = []
        for row in cursor.fetchall():
            columns = [desc[0] for desc in cursor.description]
            clients.append(dict(zip(columns, row)))
        
        return clients
    
    def get_punishments(self, limit=50):
        """–ü–æ–ª—É—á–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –Ω–∞–∫–∞–∑–∞–Ω–∏–π"""
        cursor = self.conn.cursor()
        cursor.execute('''
            SELECT * FROM punishments 
            ORDER BY created DESC 
            LIMIT ?
        ''', (limit,))
        
        punishments = []
        for row in cursor.fetchall():
            columns = [desc[0] for desc in cursor.description]
            punishments.append(dict(zip(columns, row)))
        
        return punishments
    
    def cleanup_old_data(self):
        """–û—á–∏—â–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ"""
        cursor = self.conn.cursor()
        
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ (–Ω–µ –±—ã–ª–∏ –æ–Ω–ª–∞–π–Ω 7 –¥–Ω–µ–π)
        week_ago = datetime.now() - timedelta(days=7)
        cursor.execute('DELETE FROM clients WHERE last_seen < ?', (week_ago,))
        
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –Ω–∞–∫–∞–∑–∞–Ω–∏—è (30 –¥–Ω–µ–π)
        month_ago = datetime.now() - timedelta(days=30)
        cursor.execute('DELETE FROM punishments WHERE created < ?', (month_ago,))
        
        self.conn.commit()

class AdminHandler(BaseHTTPRequestHandler):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –∞–¥–º–∏–Ω–∫–æ–π"""
    
    admin_system = AdminSystem()
    
    def do_GET(self):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ GET –∑–∞–ø—Ä–æ—Å–æ–≤"""
        path = self.path.split('?')[0]
        
        if path == '/':
            self.send_admin_login()
        elif path == '/admin':
            self.send_admin_panel()
        elif path == '/api/clients':
            self.send_json(self.admin_system.get_all_clients())
        elif path == '/api/punishments':
            self.send_json(self.admin_system.get_punishments())
        elif path == '/api/vbs_scripts':
            self.send_json(self.admin_system.get_vbs_scripts())
        elif path == '/api/stats':
            self.send_stats()
        elif path == '/logout':
            self.handle_logout()
        else:
            self.send_error(404, "–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
    
    def do_POST(self):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ POST –∑–∞–ø—Ä–æ—Å–æ–≤"""
        path = self.path
        
        if path == '/api/login':
            self.handle_login()
        elif path == '/api/register_client':
            self.handle_client_registration()
        elif path == '/api/send_vbs':
            self.handle_send_vbs()
        elif path == '/api/ban':
            self.handle_ban()
        elif path == '/api/mute':
            self.handle_mute()
        elif path == '/api/unban':
            self.handle_unban()
        elif path == '/api/unmute':
            self.handle_unmute()
        elif path == '/api/save_vbs':
            self.handle_save_vbs()
        else:
            self.send_error(404, "–ú–µ—Ç–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    def handle_login(self):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥–∞ –∞–¥–º–∏–Ω–∞"""
        content_length = int(self.headers['Content-Length'])
        post_data = self.rfile.read(content_length)
        data = json.loads(post_data.decode('utf-8'))
        
        login = data.get('login', '')
        password = data.get('password', '')
        
        if self.admin_system.authenticate_admin(login, password):
            session_id = self.admin_system.create_session(login)
            
            self.send_response(200)
            self.send_header('Content-type', 'application/json')
            self.send_header('Set-Cookie', f'session={session_id}; Path=/')
            self.end_headers()
            
            response = {'success': True, 'session': session_id}
            self.wfile.write(json.dumps(response).encode('utf-8'))
        else:
            self.send_json({'success': False, 'error': '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å'})
    
    def handle_client_registration(self):
        """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞"""
        content_length = int(self.headers['Content-Length'])
        post_data = self.rfile.read(content_length)
        data = json.loads(post_data.decode('utf-8'))
        
        client_ip = self.client_address[0]
        client_name = data.get('name', '–ê–Ω–æ–Ω–∏–º')
        
        token = self.admin_system.register_client(client_ip, client_name)
        
        if token:
            self.send_json({'success': True, 'token': token})
        else:
            self.send_json({'success': False, 'error': '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏'})
    
    def handle_send_vbs(self):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ VBS –∫–ª–∏–µ–Ω—Ç—É"""
        content_length = int(self.headers['Content-Length'])
        post_data = self.rfile.read(content_length)
        data = json.loads(post_data.decode('utf-8'))
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Å—Å–∏—é –∞–¥–º–∏–Ω–∞
        session_id = self.get_cookie('session')
        if not session_id or not self.admin_system.validate_session(session_id):
            self.send_json({'success': False, 'error': '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è'})
            return
        
        client_ip = data.get('client_ip')
        vbs_code = data.get('vbs_code')
        
        if not client_ip or not vbs_code:
            self.send_json({'success': False, 'error': '–ù–µ —É–∫–∞–∑–∞–Ω IP –∏–ª–∏ –∫–æ–¥ VBS'})
            return
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –∑–∞–±–∞–Ω–µ–Ω –ª–∏ –∫–ª–∏–µ–Ω—Ç
        client = self.admin_system.get_client(client_ip)
        if client and client.get('is_banned'):
            self.send_json({'success': False, 'error': '–ö–ª–∏–µ–Ω—Ç –∑–∞–±–∞–Ω–µ–Ω'})
            return
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º VBS –∫–ª–∏–µ–Ω—Ç—É
        success = self.send_vbs_to_client(client_ip, vbs_code)
        
        if success:
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            cursor = self.admin_system.conn.cursor()
            cursor.execute('''
                UPDATE clients 
                SET messages_sent = messages_sent + 1 
                WHERE ip = ?
            ''', (client_ip,))
            self.admin_system.conn.commit()
            
            self.send_json({'success': True})
        else:
            self.send_json({'success': False, 'error': '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏'})
    
    def handle_ban(self):
        """–ë–∞–Ω –∫–ª–∏–µ–Ω—Ç–∞"""
        content_length = int(self.headers['Content-Length'])
        post_data = self.rfile.read(content_length)
        data = json.loads(post_data.decode('utf-8'))
        
        session_id = self.get_cookie('session')
        if not session_id or not self.admin_system.validate_session(session_id):
            self.send_json({'success': False, 'error': '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è'})
            return
        
        client_ip = data.get('client_ip')
        reason = data.get('reason', '–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª')
        duration = int(data.get('duration', 60))  # –º–∏–Ω—É—Ç—ã
        
        session = self.admin_system.sessions.get(session_id)
        admin = session['login'] if session else 'System'
        
        success = self.admin_system.ban_client(client_ip, admin, reason, duration)
        self.send_json({'success': success})
    
    def handle_mute(self):
        """–ú—É—Ç –∫–ª–∏–µ–Ω—Ç–∞"""
        content_length = int(self.headers['Content-Length'])
        post_data = self.rfile.read(content_length)
        data = json.loads(post_data.decode('utf-8'))
        
        session_id = self.get_cookie('session')
        if not session_id or not self.admin_system.validate_session(session_id):
            self.send_json({'success': False, 'error': '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è'})
            return
        
        client_ip = data.get('client_ip')
        reason = data.get('reason', '–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª')
        duration = int(data.get('duration', 30))  # –º–∏–Ω—É—Ç—ã
        
        session = self.admin_system.sessions.get(session_id)
        admin = session['login'] if session else 'System'
        
        success = self.admin_system.mute_client(client_ip, admin, reason, duration)
        self.send_json({'success': success})
    
    def send_vbs_to_client(self, client_ip, vbs_code):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç VBS —Å–∫—Ä–∏–ø—Ç –∫–ª–∏–µ–Ω—Ç—É"""
        try:
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º VBS –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
            import tempfile
            with tempfile.NamedTemporaryFile(mode='w', suffix='.vbs', delete=False, encoding='utf-8') as f:
                f.write(vbs_code)
                vbs_path = f.name
            
            # –°–æ–∑–¥–∞–µ–º —Å–æ–∫–µ—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            client_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            client_socket.settimeout(5)
            
            # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –∫–ª–∏–µ–Ω—Ç—É (–∫–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω —Å–ª—É—à–∞—Ç—å –ø–æ—Ä—Ç 7777)
            client_socket.connect((client_ip, 7777))
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ VBS
            data = {
                'type': 'execute_vbs',
                'vbs_path': vbs_path,
                'timestamp': time.time()
            }
            
            client_socket.send(json.dumps(data).encode('utf-8'))
            client_socket.close()
            
            # –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
            threading.Timer(10, lambda: os.remove(vbs_path) if os.path.exists(vbs_path) else None).start()
            
            return True
            
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ VBS: {e}")
            return False
    
    def send_admin_login(self):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞ –∞–¥–º–∏–Ω–∞"""
        html = '''
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Admin Login - Error Server</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    height: 100vh;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                }
                .login-box {
                    background: white;
                    padding: 40px;
                    border-radius: 10px;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                    width: 350px;
                }
                h1 {
                    color: #333;
                    text-align: center;
                    margin-bottom: 30px;
                }
                .input-group {
                    margin-bottom: 20px;
                }
                label {
                    display: block;
                    margin-bottom: 5px;
                    color: #666;
                }
                input {
                    width: 100%;
                    padding: 10px;
                    border: 1px solid #ddd;
                    border-radius: 5px;
                    font-size: 16px;
                }
                button {
                    width: 100%;
                    padding: 12px;
                    background: #4CAF50;
                    color: white;
                    border: none;
                    border-radius: 5px;
                    font-size: 16px;
                    cursor: pointer;
                }
                button:hover {
                    background: #45a049;
                }
                .error {
                    color: #f44336;
                    text-align: center;
                    margin-top: 10px;
                }
            </style>
        </head>
        <body>
            <div class="login-box">
                <h1>üîê Admin Login</h1>
                <form id="loginForm">
                    <div class="input-group">
                        <label>–õ–æ–≥–∏–Ω:</label>
                        <input type="text" id="login" required>
                    </div>
                    <div class="input-group">
                        <label>–ü–∞—Ä–æ–ª—å:</label>
                        <input type="password" id="password" required>
                    </div>
                    <button type="submit">–í–æ–π—Ç–∏</button>
                    <div id="error" class="error"></div>
                </form>
            </div>
            <script>
                document.getElementById('loginForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const login = document.getElementById('login').value;
                    const password = document.getElementById('password').value;
                    
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({login, password})
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        window.location.href = '/admin';
                    } else {
                        document.getElementById('error').textContent = data.error;
                    }
                });
            </script>
        </body>
        </html>
        '''
        
        self.send_response(200)
        self.send_header('Content-type', 'text/html; charset=utf-8')
        self.end_headers()
        self.wfile.write(html.encode('utf-8'))
    
    def send_admin_panel(self):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
        session_id = self.get_cookie('session')
        if not session_id or not self.admin_system.validate_session(session_id):
            self.redirect('/')
            return
        
        html = '''
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Admin Panel - Error Server</title>
            <style>
                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    margin: 0;
                    background: #f5f5f5;
                }
                .header {
                    background: #2c3e50;
                    color: white;
                    padding: 15px 30px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                .header h1 {
                    margin: 0;
                    font-size: 1.5em;
                }
                .logout-btn {
                    background: #e74c3c;
                    color: white;
                    border: none;
                    padding: 8px 15px;
                    border-radius: 5px;
                    cursor: pointer;
                }
                .logout-btn:hover {
                    background: #c0392b;
                }
                .container {
                    display: grid;
                    grid-template-columns: 300px 1fr;
                    gap: 20px;
                    padding: 20px;
                    max-width: 1400px;
                    margin: 0 auto;
                }
                .sidebar {
                    background: white;
                    border-radius: 10px;
                    padding: 20px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                }
                .main-content {
                    display: grid;
                    gap: 20px;
                }
                .card {
                    background: white;
                    border-radius: 10px;
                    padding: 20px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                }
                .card h2 {
                    margin-top: 0;
                    color: #2c3e50;
                    border-bottom: 2px solid #3498db;
                    padding-bottom: 10px;
                }
                .tab-buttons {
                    display: flex;
                    margin-bottom: 20px;
                    border-bottom: 1px solid #ddd;
                }
                .tab-btn {
                    padding: 10px 20px;
                    background: none;
                    border: none;
                    border-bottom: 3px solid transparent;
                    cursor: pointer;
                    font-weight: 500;
                }
                .tab-btn.active {
                    border-bottom-color: #3498db;
                    color: #3498db;
                }
                .tab-content {
                    display: none;
                }
                .tab-content.active {
                    display: block;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                }
                th, td {
                    padding: 12px 15px;
                    text-align: left;
                    border-bottom: 1px solid #ddd;
                }
                th {
                    background: #f8f9fa;
                    font-weight: 600;
                }
                tr:hover {
                    background: #f5f5f5;
                }
                .status-banned {
                    color: #e74c3c;
                    font-weight: bold;
                }
                .status-muted {
                    color: #f39c12;
                    font-weight: bold;
                }
                .status-online {
                    color: #27ae60;
                    font-weight: bold;
                }
                .status-offline {
                    color: #95a5a6;
                }
                .btn {
                    padding: 6px 12px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 0.9em;
                    margin: 2px;
                }
                .btn-send {
                    background: #3498db;
                    color: white;
                }
                .btn-ban {
                    background: #e74c3c;
                    color: white;
                }
                .btn-mute {
                    background: #f39c12;
                    color: white;
                }
                .btn-unban {
                    background: #27ae60;
                    color: white;
                }
                .btn-unmute {
                    background: #9b59b6;
                    color: white;
                }
                textarea {
                    width: 100%;
                    height: 150px;
                    padding: 10px;
                    border: 1px solid #ddd;
                    border-radius: 5px;
                    font-family: monospace;
                    font-size: 14px;
                }
                .form-group {
                    margin-bottom: 15px;
                }
                label {
                    display: block;
                    margin-bottom: 5px;
                    font-weight: 500;
                }
                input, select {
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #ddd;
                    border-radius: 5px;
                }
                .btn-primary {
                    background: #3498db;
                    color: white;
                    padding: 10px 20px;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                    width: 100%;
                }
                .stat-box {
                    background: #f8f9fa;
                    padding: 15px;
                    border-radius: 8px;
                    text-align: center;
                    margin-bottom: 15px;
                }
                .stat-value {
                    font-size: 2em;
                    font-weight: bold;
                    color: #2c3e50;
                }
                .stat-label {
                    color: #7f8c8d;
                    font-size: 0.9em;
                }
                .vbs-item {
                    background: #f8f9fa;
                    padding: 15px;
                    border-radius: 8px;
                    margin-bottom: 10px;
                }
                .vbs-name {
                    font-weight: bold;
                    margin-bottom: 5px;
                }
                .vbs-meta {
                    color: #7f8c8d;
                    font-size: 0.9em;
                    margin-bottom: 10px;
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>‚öôÔ∏è Admin Panel - Error Server</h1>
                <button class="logout-btn" onclick="logout()">üö™ –í—ã–π—Ç–∏</button>
            </div>
            
            <div class="container">
                <div class="sidebar">
                    <div class="tab-buttons">
                        <button class="tab-btn active" onclick="showTab('clients')">üë• –ö–ª–∏–µ–Ω—Ç—ã</button>
                        <button class="tab-btn" onclick="showTab('vbs')">üìù VBS</button>
                        <button class="tab-btn" onclick="showTab('punishments')">‚öñÔ∏è –ù–∞–∫–∞–∑–∞–Ω–∏—è</button>
                        <button class="tab-btn" onclick="showTab('stats')">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
                    </div>
                    
                    <div class="stat-box">
                        <div class="stat-value" id="total-clients">0</div>
                        <div class="stat-label">–í—Å–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
                    </div>
                    
                    <div class="stat-box">
                        <div class="stat-value" id="online-now">0</div>
                        <div class="stat-label">–û–Ω–ª–∞–π–Ω —Å–µ–π—á–∞—Å</div>
                    </div>
                    
                    <div class="stat-box">
                        <div class="stat-value" id="banned-count">0</div>
                        <div class="stat-label">–ó–∞–±–∞–Ω–µ–Ω–æ</div>
                    </div>
                    
                    <div class="stat-box">
                        <div class="stat-value" id="vbs-sent">0</div>
                        <div class="stat-label">VBS –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</div>
                    </div>
                </div>
                
                <div class="main-content">
                    <div class="tab-content active" id="clients-tab">
                        <div class="card">
                            <h2>üìã –°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤</h2>
                            <table id="clients-table">
                                <thead>
                                    <tr>
                                        <th>IP</th>
                                        <th>–ò–º—è</th>
                                        <th>–°—Ç–∞—Ç—É—Å</th>
                                        <th>–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
                                        <th>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                    </tr>
                                </thead>
                                <tbody id="clients-list">
                                    <tr><td colspan="6">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="card">
                            <h2>üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å VBS</h2>
                            <div class="form-group">
                                <label>–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞:</label>
                                <select id="client-select"></select>
                            </div>
                            <div class="form-group">
                                <label>–ö–æ–¥ VBS:</label>
                                <textarea id="vbs-code" placeholder='MsgBox "–ü—Ä–∏–≤–µ—Ç –æ—Ç –∞–¥–º–∏–Ω–∞!", vbInformation, "–°–æ–æ–±—â–µ–Ω–∏–µ"'></textarea>
                            </div>
                            <button class="btn-primary" onclick="sendVbs()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å VBS</button>
                            <div id="send-result"></div>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="vbs-tab">
                        <div class="card">
                            <h2>üíæ –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ VBS —Å–∫—Ä–∏–ø—Ç—ã</h2>
                            <div id="vbs-scripts-list"></div>
                            
                            <h2 style="margin-top: 30px;">‚ûï –ù–æ–≤—ã–π VBS —Å–∫—Ä–∏–ø—Ç</h2>
                            <div class="form-group">
                                <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞:</label>
                                <input type="text" id="new-vbs-name" placeholder="–ú–æ–π —Å–∫—Ä–∏–ø—Ç">
                            </div>
                            <div class="form-group">
                                <label>–ö–æ–¥ VBS:</label>
                                <textarea id="new-vbs-code" placeholder='MsgBox "–ü—Ä–∏–º–µ—Ä", vbCritical, "–í–Ω–∏–º–∞–Ω–∏–µ!"'></textarea>
                            </div>
                            <button class="btn-primary" onclick="saveVbsScript()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–∫—Ä–∏–ø—Ç</button>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="punishments-tab">
                        <div class="card">
                            <h2>‚öñÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–∫–∞–∑–∞–Ω–∏—è–º–∏</h2>
                            <div class="form-group">
                                <label>–ö–ª–∏–µ–Ω—Ç (IP):</label>
                                <input type="text" id="punish-ip" placeholder="192.168.1.100">
                            </div>
                            <div class="form-group">
                                <label>–î–µ–π—Å—Ç–≤–∏–µ:</label>
                                <select id="punish-action">
                                    <option value="ban">üö´ –ó–∞–±–∞–Ω–∏—Ç—å</option>
                                    <option value="mute">üîá –ó–∞–º—É—Ç–∏—Ç—å</option>
                                    <option value="unban">‚úÖ –†–∞–∑–±–∞–Ω–∏—Ç—å</option>
                                    <option value="unmute">üîä –†–∞–∑–º—É—Ç–∏—Ç—å</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>–ü—Ä–∏—á–∏–Ω–∞:</label>
                                <input type="text" id="punish-reason" placeholder="–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª">
                            </div>
                            <div class="form-group">
                                <label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω—É—Ç—ã):</label>
                                <input type="number" id="punish-duration" value="60" min="1">
                            </div>
                            <button class="btn-primary" onclick="applyPunishment()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                        </div>
                        
                        <div class="card">
                            <h2>üìú –ò—Å—Ç–æ—Ä–∏—è –Ω–∞–∫–∞–∑–∞–Ω–∏–π</h2>
                            <table id="punishments-table">
                                <thead>
                                    <tr>
                                        <th>–í—Ä–µ–º—è</th>
                                        <th>–ö–ª–∏–µ–Ω—Ç</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                                        <th>–ü—Ä–∏—á–∏–Ω–∞</th>
                                        <th>–ê–¥–º–∏–Ω</th>
                                    </tr>
                                </thead>
                                <tbody id="punishments-list">
                                    <tr><td colspan="5">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="stats-tab">
                        <div class="card">
                            <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞</h2>
                            <div id="stats-content">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <script>
                // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∫–ª–∞–¥–∫–∞–º–∏
                function showTab(tabName) {
                    // –°–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
                    document.querySelectorAll('.tab-content').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    document.querySelectorAll('.tab-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é
                    document.getElementById(tabName + '-tab').classList.add('active');
                    event.target.classList.add('active');
                }
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
                async function loadClients() {
                    try {
                        const response = await fetch('/api/clients');
                        const clients = await response.json();
                        
                        const tbody = document.getElementById('clients-list');
                        const select = document.getElementById('client-select');
                        
                        tbody.innerHTML = '';
                        select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞</option>';
                        
                        let onlineCount = 0;
                        let bannedCount = 0;
                        let totalSent = 0;
                        
                        clients.forEach(client => {
                            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                            const lastSeen = new Date(client.last_seen);
                            const now = new Date();
                            const minutesAgo = (now - lastSeen) / (1000 * 60);
                            const isOnline = minutesAgo < 5;
                            
                            if (isOnline) onlineCount++;
                            if (client.is_banned) bannedCount++;
                            totalSent += client.messages_sent || 0;
                            
                            let status = '';
                            if (client.is_banned) {
                                status = '<span class="status-banned">üö´ –ó–∞–±–∞–Ω–µ–Ω</span>';
                            } else if (client.is_muted) {
                                status = '<span class="status-muted">üîá –í –º—É—Ç–µ</span>';
                            } else if (isOnline) {
                                status = '<span class="status-online">‚úÖ –û–Ω–ª–∞–π–Ω</span>';
                            } else {
                                status = '<span class="status-offline">‚ö´ –û—Ñ—Ñ–ª–∞–π–Ω</span>';
                            }
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Ç–∞–±–ª–∏—Ü—É
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${client.ip}</td>
                                <td>${client.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</td>
                                <td>${status}</td>
                                <td>${lastSeen.toLocaleString('ru-RU')}</td>
                                <td>${client.messages_sent || 0}</td>
                                <td>
                                    <button class="btn btn-send" onclick="selectClient('${client.ip}')">üì§</button>
                                    <button class="btn btn-ban" onclick="quickBan('${client.ip}')">üö´</button>
                                    <button class="btn btn-mute" onclick="quickMute('${client.ip}')">üîá</button>
                                    ${client.is_banned ? 
                                        '<button class="btn btn-unban" onclick="quickUnban(\'' + client.ip + '\')">‚úÖ</button>' : 
                                        ''}
                                </td>
                            `;
                            tbody.appendChild(row);
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
                            const option = document.createElement('option');
                            option.value = client.ip;
                            option.textContent = `${client.name} (${client.ip})`;
                            select.appendChild(option);
                        });
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                        document.getElementById('total-clients').textContent = clients.length;
                        document.getElementById('online-now').textContent = onlineCount;
                        document.getElementById('banned-count').textContent = bannedCount;
                        document.getElementById('vbs-sent').textContent = totalSent;
                        
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤:', error);
                    }
                }
                
                async function loadPunishments() {
                    try {
                        const response = await fetch('/api/punishments');
                        const punishments = await response.json();
                        
                        const tbody = document.getElementById('punishments-list');
                        tbody.innerHTML = '';
                        
                        punishments.forEach(p => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${new Date(p.created).toLocaleString('ru-RU')}</td>
                                <td>${p.client_ip}</td>
                                <td>${getActionIcon(p.action)} ${p.action}</td>
                                <td>${p.reason}</td>
                                <td>${p.admin}</td>
                            `;
                            tbody.appendChild(row);
                        });
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞–∫–∞–∑–∞–Ω–∏–π:', error);
                    }
                }
                
                async function loadVbsScripts() {
                    try {
                        const response = await fetch('/api/vbs_scripts');
                        const scripts = await response.json();
                        
                        const container = document.getElementById('vbs-scripts-list');
                        container.innerHTML = '';
                        
                        if (scripts.length === 0) {
                            container.innerHTML = '<p>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤</p>';
                            return;
                        }
                        
                        scripts.forEach(script => {
                            const div = document.createElement('div');
                            div.className = 'vbs-item';
                            div.innerHTML = `
                                <div class="vbs-name">${script.name}</div>
                                <div class="vbs-meta">
                                    –°–æ–∑–¥–∞–ª: ${script.created_by} | 
                                    –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω: ${script.uses} —Ä–∞–∑ | 
                                    ${new Date(script.created_at).toLocaleDateString('ru-RU')}
                                </div>
                                <pre style="background: #2c3e50; color: white; padding: 10px; border-radius: 5px; overflow: auto;">${escapeHtml(script.code)}</pre>
                                <button class="btn btn-send" onclick="useVbsScript(${script.id})">üì§ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</button>
                            `;
                            container.appendChild(div);
                        });
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤:', error);
                    }
                }
                
                // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
                function getActionIcon(action) {
                    const icons = {
                        'ban': 'üö´',
                        'mute': 'üîá',
                        'unban': '‚úÖ',
                        'unmute': 'üîä'
                    };
                    return icons[action] || '‚öôÔ∏è';
                }
                
                function escapeHtml(text) {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                }
                
                // –î–µ–π—Å—Ç–≤–∏—è
                function selectClient(ip) {
                    document.getElementById('client-select').value = ip;
                    showTab('clients');
                    document.getElementById('vbs-code').focus();
                }
                
                async function sendVbs() {
                    const clientIp = document.getElementById('client-select').value;
                    const vbsCode = document.getElementById('vbs-code').value;
                    
                    if (!clientIp) {
                        alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞!');
                        return;
                    }
                    
                    if (!vbsCode.trim()) {
                        alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ VBS!');
                        return;
                    }
                    
                    try {
                        const response = await fetch('/api/send_vbs', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                client_ip: clientIp,
                                vbs_code: vbsCode
                            })
                        });
                        
                        const result = await response.json();
                        const resultDiv = document.getElementById('send-result');
                        
                        if (result.success) {
                            resultDiv.innerHTML = '<div style="color: green;">‚úÖ VBS –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!</div>';
                            loadClients(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                        } else {
                            resultDiv.innerHTML = `<div style="color: red;">‚ùå –û—à–∏–±–∫–∞: ${result.error}</div>`;
                        }
                        
                        setTimeout(() => {
                            resultDiv.innerHTML = '';
                        }, 3000);
                    } catch (error) {
                        alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error.message);
                    }
                }
                
                async function quickBan(ip) {
                    if (!confirm(`–ó–∞–±–∞–Ω–∏—Ç—å ${ip}?`)) return;
                    
                    try {
                        await fetch('/api/ban', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                client_ip: ip,
                                reason: '–ë—ã—Å—Ç—Ä—ã–π –±–∞–Ω',
                                duration: 60
                            })
                        });
                        
                        loadClients();
                        loadPunishments();
                    } catch (error) {
                        alert('–û—à–∏–±–∫–∞: ' + error.message);
                    }
                }
                
                async function quickMute(ip) {
                    if (!confirm(`–ó–∞–º—É—Ç–∏—Ç—å ${ip}?`)) return;
                    
                    try {
                        await fetch('/api/mute', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                client_ip: ip,
                                reason: '–ë—ã—Å—Ç—Ä—ã–π –º—É—Ç',
                                duration: 30
                            })
                        });
                        
                        loadClients();
                        loadPunishments();
                    } catch (error) {
                        alert('–û—à–∏–±–∫–∞: ' + error.message);
                    }
                }
                
                async function quickUnban(ip) {
                    try {
                        await fetch('/api/unban', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ client_ip: ip })
                        });
                        
                        loadClients();
                        loadPunishments();
                    } catch (error) {
                        alert('–û—à–∏–±–∫–∞: ' + error.message);
                    }
                }
                
                async function applyPunishment() {
                    const ip = document.getElementById('punish-ip').value;
                    const action = document.getElementById('punish-action').value;
                    const reason = document.getElementById('punish-reason').value;
                    const duration = document.getElementById('punish-duration').value;
                    
                    if (!ip) {
                        alert('–í–≤–µ–¥–∏—Ç–µ IP –∫–ª–∏–µ–Ω—Ç–∞!');
                        return;
                    }
                    
                    const endpoint = {
                        'ban': '/api/ban',
                        'mute': '/api/mute',
                        'unban': '/api/unban',
                        'unmute': '/api/unmute'
                    }[action];
                    
                    try {
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                client_ip: ip,
                                reason: reason,
                                duration: action.includes('un') ? 0 : parseInt(duration)
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            alert('‚úÖ –ù–∞–∫–∞–∑–∞–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ!');
                            loadClients();
                            loadPunishments();
                        } else {
                            alert('‚ùå –û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                        }
                    } catch (error) {
                        alert('–û—à–∏–±–∫–∞: ' + error.message);
                    }
                }
                
                async function saveVbsScript() {
                    const name = document.getElementById('new-vbs-name').value;
                    const code = document.getElementById('new-vbs-code').value;
                    
                    if (!name.trim() || !code.trim()) {
                        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–æ–¥!');
                        return;
                    }
                    
                    try {
                        const response = await fetch('/api/save_vbs', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ name, code })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            alert('‚úÖ –°–∫—Ä–∏–ø—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
                            loadVbsScripts();
                            document.getElementById('new-vbs-name').value = '';
                            document.getElementById('new-vbs-code').value = '';
                        } else {
                            alert('‚ùå –û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                        }
                    } catch (error) {
                        alert('–û—à–∏–±–∫–∞: ' + error.message);
                    }
                }
                
                async function useVbsScript(scriptId) {
                    // –ü–æ–ª—É—á–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∏ –≤—Å—Ç–∞–≤–ª—è–µ–º –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä
                    try {
                        const response = await fetch('/api/vbs_scripts');
                        const scripts = await response.json();
                        const script = scripts.find(s => s.id == scriptId);
                        
                        if (script) {
                            showTab('clients');
                            document.getElementById('vbs-code').value = script.code;
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞:', error);
                    }
                }
                
                function logout() {
                    document.cookie = "session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                    window.location.href = '/';
                }
                
                // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
                setInterval(loadClients, 10000); // –ö–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
                
                // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
                document.addEventListener('DOMContentLoaded', () => {
                    loadClients();
                    loadPunishments();
                    loadVbsScripts();
                });
            </script>
        </body>
        </html>
        '''
        
        self.send_response(200)
        self.send_header('Content-type', 'text/html; charset=utf-8')
        self.end_headers()
        self.wfile.write(html.encode('utf-8'))
    
    def send_json(self, data):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç JSON –æ—Ç–≤–µ—Ç"""
        self.send_response(200)
        self.send_header('Content-type', 'application/json')
        self.end_headers()
        self.wfile.write(json.dumps(data).encode('utf-8'))
    
    def redirect(self, location):
        """–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ"""
        self.send_response(302)
        self.send_header('Location', location)
        self.end_headers()
    
    def get_cookie(self, name):
        """–ü–æ–ª—É—á–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ cookie"""
        cookies = self.headers.get('Cookie', '')
        for cookie in cookies.split(';'):
            if '=' in cookie:
                key, value = cookie.strip().split('=', 1)
                if key == name:
                    return value
        return None
    
    def handle_logout(self):
        """–í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã"""
        session_id = self.get_cookie('session')
        if session_id and session_id in self.admin_system.sessions:
            del self.admin_system.sessions[session_id]
        
        self.redirect('/')
    
    def handle_unban(self):
        """–†–∞–∑–±–∞–Ω –∫–ª–∏–µ–Ω—Ç–∞"""
        content_length = int(self.headers['Content-Length'])
        post_data = self.rfile.read(content_length)
        data = json.loads(post_data.decode('utf-8'))
        
        session_id = self.get_cookie('session')
        if not session_id or not self.admin_system.validate_session(session_id):
            self.send_json({'success': False, 'error': '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è'})
            return
        
        client_ip = data.get('client_ip')
        session = self.admin_system.sessions.get(session_id)
        admin = session['login'] if session else 'System'
        
        success = self.admin_system.unban_client(client_ip, admin)
        self.send_json({'success': success})
    
    def handle_unmute(self):
        """–†–∞–∑–º—É—Ç –∫–ª–∏–µ–Ω—Ç–∞"""
        content_length = int(self.headers['Content-Length'])
        post_data = self.rfile.read(content_length)
        data = json.loads(post_data.decode('utf-8'))
        
        session_id = self.get_cookie('session')
        if not session_id or not self.admin_system.validate_session(session_id):
            self.send_json({'success': False, 'error': '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è'})
            return
        
        client_ip = data.get('client_ip')
        session = self.admin_system.sessions.get(session_id)
        admin = session['login'] if session else 'System'
        
        success = self.admin_system.unmute_client(client_ip, admin)
        self.send_json({'success': success})
    
    def handle_save_vbs(self):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ VBS —Å–∫—Ä–∏–ø—Ç–∞"""
        content_length = int(self.headers['Content-Length'])
        post_data = self.rfile.read(content_length)
        data = json.loads(post_data.decode('utf-8'))
        
        session_id = self.get_cookie('session')
        if not session_id or not self.admin_system.validate_session(session_id):
            self.send_json({'success': False, 'error': '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è'})
            return
        
        name = data.get('name', '')
        code = data.get('code', '')
        
        if not name or not code:
            self.send_json({'success': False, 'error': '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–æ–¥'})
            return
        
        session = self.admin_system.sessions.get(session_id)
        created_by = session['login'] if session else 'Unknown'
        
        script_id = self.admin_system.save_vbs_script(name, code, created_by)
        
        if script_id:
            self.send_json({'success': True, 'id': script_id})
        else:
            self.send_json({'success': False, 'error': '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'})
    
    def send_stats(self):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"""
        cursor = self.admin_system.conn.cursor()
        
        # –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        cursor.execute('SELECT COUNT(*) as total FROM clients')
        total_clients = cursor.fetchone()[0]
        
        cursor.execute('SELECT COUNT(*) as banned FROM clients WHERE is_banned = 1')
        banned_clients = cursor.fetchone()[0]
        
        cursor.execute('SELECT COUNT(*) as muted FROM clients WHERE is_muted = 1')
        muted_clients = cursor.fetchone()[0]
        
        cursor.execute('SELECT SUM(messages_sent) as total_sent FROM clients')
        total_sent = cursor.fetchone()[0] or 0
        
        cursor.execute('SELECT COUNT(*) as total_scripts FROM vbs_scripts')
        total_scripts = cursor.fetchone()[0]
        
        cursor.execute('SELECT SUM(uses) as total_uses FROM vbs_scripts')
        total_uses = cursor.fetchone()[0] or 0
        
        stats = {
            'total_clients': total_clients,
            'banned_clients': banned_clients,
            'muted_clients': muted_clients,
            'total_messages_sent': total_sent,
            'total_vbs_scripts': total_scripts,
            'total_vbs_uses': total_uses,
            'server_uptime': self.get_uptime()
        }
        
        self.send_json(stats)
    
    def get_uptime(self):
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–µ—Ä–∞"""
        # –í —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤—Ä–µ–º—è —Å—Ç–∞—Ä—Ç–∞
        return "–ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ"

def start_admin_server(port=8080):
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç —Å–µ—Ä–≤–µ—Ä —Å –∞–¥–º–∏–Ω–∫–æ–π"""
    server_address = ('', port)
    httpd = HTTPServer(server_address, AdminHandler)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –æ—á–∏—Å—Ç–∫—É —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–æ–Ω–µ
    def cleanup_task():
        while True:
            import time
            time.sleep(3600)  # –ö–∞–∂–¥—ã–π —á–∞—Å
            AdminHandler.admin_system.cleanup_old_data()
    
    cleanup_thread = threading.Thread(target=cleanup_task, daemon=True)
    cleanup_thread.start()
    
    print("="*60)
    print("     –ê–î–ú–ò–ù –°–ï–†–í–ï–† –ó–ê–ü–£–©–ï–ù")
    print("="*60)
    print(f"üåê –ê–¥—Ä–µ—Å: http://localhost:{port}")
    print(f"üîê –õ–æ–≥–∏–Ω –∞–¥–º–∏–Ω–∞: {ADMIN_LOGIN}")
    print(f"üîë –ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞: 1286")
    print("="*60)
    print("\n–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:")
    print("- –ë–∞–Ω–∏—Ç—å/–º—É—Ç–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤")
    print("- –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å VBS —Å–∫—Ä–∏–ø—Ç—ã")
    print("- –°–æ—Ö—Ä–∞–Ω—è—Ç—å —à–∞–±–ª–æ–Ω—ã VBS")
    print("- –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É")
    print("="*60)
    
    try:
        httpd.serve_forever()
    except KeyboardInterrupt:
        print("\nüõë –°–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        httpd.server_close()

if __name__ == "__main__":
    start_admin_server()
